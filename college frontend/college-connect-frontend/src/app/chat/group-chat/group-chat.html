<div class="container-fluid py-4 group-chat-container">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-9">

      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Group Chats</h5>
        </div>

        <div class="card-body p-4">

          <!-- Create Group Form -->
          <div *ngIf="isManager" class="mb-4">
            <h6>Create New Group</h6>
            <form [formGroup]="groupForm" (ngSubmit)="createGroup()" class="row g-2">
              <div class="col-md-4">
                <input class="form-control" formControlName="name" placeholder="Group Name">
              </div>
              <div class="col-md-4">
                <input class="form-control" formControlName="type" placeholder="Group Type">
              </div>
              <div class="col-md-4">
                <button class="btn btn-success w-100" type="submit" [disabled]="groupForm.invalid">
                  Create
                </button>
              </div>
            </form>
          </div>

          <!-- Group List -->
          <div class="mb-4">
            <h6>Your Groups</h6>
            <ul class="list-group">
              <li *ngFor="let g of groups"
                  (click)="selectGroup(g)"
                  class="list-group-item d-flex justify-content-between align-items-center"
                  [class.active]="selectedGroup?.id === g.id"
                  style="cursor: pointer;">
                {{ g.name }}
                <button *ngIf="isManager"
                        class="btn btn-sm btn-outline-danger"
                        (click)="deleteGroup(g.id); $event.stopPropagation()">
                  âœ•
                </button>
              </li>
            </ul>
          </div>

          <!-- Chat & Members Section -->
          <div *ngIf="selectedGroup">
            <h5 class="mb-3">Group: {{ selectedGroup.name }}</h5>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3">
              <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab==='chat'" (click)="activeTab='chat'">Chat</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab==='members'" (click)="switchToMembers()">Members</a>
              </li>
            </ul>

            <!-- Chat View -->
            <div *ngIf="activeTab === 'chat'"
                 class="chat-tab border rounded bg-light"
                 style="height: 400px; display: flex; flex-direction: column; overflow: hidden;">

              <!-- messages -->
              <div class="flex-grow-1 overflow-auto p-3" style="background-color: #f8f9fa;">
                <div *ngFor="let m of messages" class="mb-3">
                  <div class="d-flex"
                       [ngClass]="{
                         'justify-content-end': m.senderUser === username,
                         'justify-content-start': m.senderUser !== username
                       }">
                    <div class="message-bubble p-2 rounded"
                         [ngClass]="{
                           'bg-primary text-white': m.senderUser === username,
                           'bg-light border': m.senderUser !== username
                         }">

                      <strong *ngIf="m.senderUser !== username">{{ m.senderUser }}</strong>
                      <div *ngIf="m.text">{{ m.text }}</div>
                      <img *ngIf="m.imageUrl"
                           [src]="m.imageUrl"
                           class="img-fluid rounded mt-2"
                           style="max-height: 150px;" />
                      <small class="text-muted d-block mt-1 text-end" style="font-size:.75rem;">
                        {{ m.sentOn | date:'shortTime' }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Input + File picker -->
              <form [formGroup]="messageForm"
                    (ngSubmit)="sendMessage()"
                    class="p-2 bg-white border-top d-flex align-items-center gap-2">
                <input formControlName="text"
                       type="text"
                       class="form-control"
                       placeholder="Type a messageâ€¦">
                <label class="btn btn-outline-secondary mb-0 p-1">
                  ðŸ“·
                  <input type="file"
                         accept="image/*"
                         hidden
                         (change)="onFileSelected($event)">
                </label>
                <button class="btn btn-primary"
                        type="submit"
                        [disabled]="!messageForm.value.text && !selectedFile">
                  Send
                </button>
              </form>
            </div>

            <!-- Members View -->
            <div *ngIf="activeTab === 'members'" class="members-tab mt-3">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr><th>Username</th><th *ngIf="isManager">Action</th></tr>
                </thead>
                <tbody>
                  <tr *ngFor="let u of members">
                    <td>{{ u }}</td>
                    <td *ngIf="isManager">
                      <button class="btn btn-sm btn-outline-danger"
                              (click)="removeMember(u)">
                        Remove
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>

              <div class="row g-3 mt-3" *ngIf="isManager">
                <div class="col-md-6">
                  <h6>Add Member</h6>
                  <form [formGroup]="memberForm"
                        (ngSubmit)="addMember()"
                        class="d-flex gap-2">
                    <input formControlName="username"
                           class="form-control"
                           placeholder="Username">
                    <button class="btn btn-success" type="submit"
                            [disabled]="memberForm.invalid">
                      Add
                    </button>
                  </form>
                </div>
                <div class="col-md-6">
                  <h6>Remove Member (Manual)</h6>
                  <form #removeForm="ngForm"
                        (ngSubmit)="removeMemberByForm(removeForm)"
                        class="d-flex gap-2">
                    <input name="groupName"
                           ngModel
                           [ngModel]="selectedGroup.name"
                           readonly
                           class="form-control">
                    <input name="username"
                           ngModel
                           class="form-control"
                           placeholder="Username">
                    <button class="btn btn-danger" type="submit"
                            [disabled]="removeForm.invalid">
                      Remove
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div> <!-- end selectedGroup -->
        </div>
      </div>
    </div>
  </div>
</div>
